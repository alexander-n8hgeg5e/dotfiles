#!/usr/bin/env python3

WAITFILE="/tmp/wait_for_xserverrc"

from pylib.syslog_utils import info
from subprocess import TimeoutExpired,DEVNULL
from time import time
from os import execvp
from pylib.xinit_utils import *

cmdline =   [
                'sudo', 'nice', '-n-20', 'ionice', '-c1', '-n3',
                'chrt', '-rr', '30', 'sudo', '-u',
                'xserver', 'X', ':0',
                '-quiet',
                '-ardelay', '130',
                '-arinterval', '50',
                '-listen','inet',
                '-iglx',
                '-depth', '24',
                '-allowNonLocalXvidtune',
                '-dpms',
                '-xinerama',
                'vt7',
            ]

def parse_args():
    from argparse import ArgumentParser
    a=ArgumentParser()
    a.add_argument('-D','--debug',action='store_true')
    a.add_argument('-v','--verbose',action='store_true')
    a.add_argument(dest='xserverargs',nargs='*')
    a.add_argument("-r","--restart",action='store_true',default=False)
    global args
    args=a.parse_args()
    if args.debug:
        args.verbose=True
    global stderr
    if args.verbose:
        from sys import stderr
    else:
        stderr=DEVNULL
    global stdout
    if args.debug:
        from sys import stdout
    else:
        stdout=DEVNULL
    global cmdline
    cmdline+=args.xserverargs

############
##  main  ##
############
if __name__=='__main__':
    with open(WAITFILE,mode="wt") as f:
        starttime=time()
        f.write("True, "+repr(starttime))
    info("#####################################")
    info("##  xinit xserverrc skyscraper ... ##")
    info("#####################################")
    parse_args()
    try:
        prepare_skyscraper(stop_running_xserver=True,timeoutmult=5)
    except (TimeoutExpired,Timeout):
        try:
            start_restart_skyscraper()
            prepare_skyscraper(stop_running_xserver=True,timeoutmult=5)
        except (TimeoutExpired,Timeout):
            raise SkyscraperNotAwakeError("Timeout while looking for life signs of skyscraper.")
    
    info("###########################")
    info("##  SKYSCRAPER IS READY  ##")
    info("###########################")
    info("time = "+str(round(time()-starttime,2)))
    with open(WAITFILE,mode="wt") as f:
        f.write("False, "+repr(starttime))
    execvp('ssh', ['-oControlPath=none', 'xsky'] + cmdline )

# vim: set foldlevel=0 foldnestmax=2 foldmethod=indent nowrap:
